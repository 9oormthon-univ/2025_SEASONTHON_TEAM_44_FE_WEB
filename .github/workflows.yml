name: Discord Notifications

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  pull_request:
    types: [opened, synchronize, reopened, closed] # PR ìƒì„±/ìˆ˜ì •/ì¬ì˜¤í”ˆ/ë‹«í˜
  create:
    branches: ['*'] # ë¸Œëœì¹˜ ìƒì„±
  delete:
    branches: ['*'] # ë¸Œëœì¹˜ ì‚­ì œ
  issues:
    types: [opened, closed] # ì´ìŠˆ ìƒì„±/ë‹«í˜
  push:
    branches: [develop, main] # develop, main ë¸Œëœì¹˜ì— push

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # -----------------------------
      # PR ì´ë²¤íŠ¸: ìƒì„±/ì¬ì˜¤í”ˆ/ìˆ˜ì •
      # -----------------------------
      - name: PR opened/reopened/sync ğŸ”€
        if: ${{ github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'synchronize') }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          PR_ACTION: ${{ github.event.action }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_USER: ${{ github.event.pull_request.user.login }}
          BASE: ${{ github.event.pull_request.base.ref }}
          HEAD: ${{ github.event.pull_request.head.ref }}
          COMMITS: ${{ github.event.pull_request.commits }}
        run: |
          payload=$(cat <<'JSON'
          {
            "embeds": [{
              "title": "ğŸ”€ PR ${PR_ACTION}: #${PR_NUMBER} ${PR_TITLE}",
              "url": "${PR_URL}",
              "description": "by **${PR_USER}**  â€¢  ${HEAD} â†’ ${BASE}",
              "color": 3447003,
              "fields": [
                { "name": "Repo", "value": "${REPO}", "inline": true },
                { "name": "Commits", "value": "${COMMITS}", "inline": true }
              ]
            }]
          }
          JSON
          )
          curl -s -H "Content-Type: application/json" -d "$(echo "$payload" | envsubst)" "$DISCORD_WEBHOOK_URL"

      # -----------------------------
      # PR ì´ë²¤íŠ¸: ë¨¸ì§€ë¨
      # -----------------------------
      - name: PR merged âœ…
        if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          MERGER: ${{ github.actor }}
        run: |
          payload=$(cat <<'JSON'
          {
            "embeds": [{
              "title": "âœ… Merged: #${PR_NUMBER} ${PR_TITLE}",
              "url": "${PR_URL}",
              "description": "merged by **${MERGER}**",
              "color": 5763719,
              "footer": { "text": "${REPO}" }
            }]
          }
          JSON
          )
          curl -s -H "Content-Type: application/json" -d "$(echo "$payload" | envsubst)" "$DISCORD_WEBHOOK_URL"

      # -----------------------------
      # PR ì´ë²¤íŠ¸: ë¨¸ì§€ ì•ˆ ëœ ì±„ ë‹«í˜
      # -----------------------------
      - name: PR closed without merge âŒ
        if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged != true }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          payload=$(cat <<'JSON'
          {
            "embeds": [{
              "title": "âŒ Closed: #${PR_NUMBER} ${PR_TITLE}",
              "url": "${PR_URL}",
              "color": 15548997,
              "footer": { "text": "${REPO}" }
            }]
          }
          JSON
          )
          curl -s -H "Content-Type: application/json" -d "$(echo "$payload" | envsubst)" "$DISCORD_WEBHOOK_URL"

      # -----------------------------
      # ë¸Œëœì¹˜ ìƒì„±
      # -----------------------------
      - name: Branch created ğŸŒ±
        if: ${{ github.event_name == 'create' && github.ref_type == 'branch' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref }}
          CREATOR: ${{ github.actor }}
        run: |
          payload=$(cat <<'JSON'
          { "content": "ğŸŒ± **${REPO}** ë¸Œëœì¹˜ ìƒì„±: `${BRANCH}` (by ${CREATOR})" }
          JSON
          )
          curl -s -H "Content-Type: application/json" -d "$(echo "$payload" | envsubst)" "$DISCORD_WEBHOOK_URL"

      # -----------------------------
      # ë¸Œëœì¹˜ ì‚­ì œ
      # -----------------------------
      - name: Branch deleted ğŸ”¥
        if: ${{ github.event_name == 'delete' && github.ref_type == 'branch' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref }}
          ACTOR: ${{ github.actor }}
        run: |
          payload=$(cat <<'JSON'
          { "content": "ğŸ”¥ **${REPO}** ë¸Œëœì¹˜ ì‚­ì œ: `${BRANCH}` (by ${ACTOR})" }
          JSON
          )
          curl -s -H "Content-Type: application/json" -d "$(echo "$payload" | envsubst)" "$DISCORD_WEBHOOK_URL"

      # -----------------------------
      # ì´ìŠˆ ìƒì„±
      # -----------------------------
      - name: Issue opened ğŸ›
        if: ${{ github.event_name == 'issues' && github.event.action == 'opened' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          NUM: ${{ github.event.issue.number }}
          TITLE: ${{ github.event.issue.title }}
          URL: ${{ github.event.issue.html_url }}
          USER: ${{ github.event.issue.user.login }}
        run: |
          payload=$(cat <<'JSON'
          {
            "embeds": [{
              "title": "ğŸ› Issue #${NUM}: ${TITLE}",
              "url": "${URL}",
              "description": "opened by **${USER}**",
              "color": 15844367,
              "footer": { "text": "${REPO}" }
            }]
          }
          JSON
          )
          curl -s -H "Content-Type: application/json" -d "$(echo "$payload" | envsubst)" "$DISCORD_WEBHOOK_URL"

      # -----------------------------
      # ì´ìŠˆ ë‹«í˜
      # -----------------------------
      - name: Issue closed ğŸ§¹
        if: ${{ github.event_name == 'issues' && github.event.action == 'closed' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          NUM: ${{ github.event.issue.number }}
          TITLE: ${{ github.event.issue.title }}
          URL: ${{ github.event.issue.html_url }}
          ACTOR: ${{ github.actor }}
        run: |
          payload=$(cat <<'JSON'
          {
            "embeds": [{
              "title": "ğŸ§¹ Closed Issue #${NUM}: ${TITLE}",
              "url": "${URL}",
              "description": "closed by **${ACTOR}**",
              "color": 1018364,
              "footer": { "text": "${REPO}" }
            }]
          }
          JSON
          )
          curl -s -H "Content-Type: application/json" -d "$(echo "$payload" | envsubst)" "$DISCORD_WEBHOOK_URL"

      # -----------------------------
      # develop / main ë¸Œëœì¹˜ë¡œ push
      # -----------------------------
      - name: Push to main/develop ğŸšš
        if: ${{ github.event_name == 'push' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          COMPARE: ${{ github.event.compare }}
          PUSER: ${{ github.actor }}
        run: |
          # ì»¤ë°‹ ê°œìˆ˜ ê³„ì‚° (jq ì‚¬ìš©)
          COUNT=$(jq '.commits | length' "$GITHUB_EVENT_PATH")
          export COUNT
          
          # ë””ìŠ¤ì½”ë“œ payload ìƒì„± ë° ì „ì†¡
          payload=$(cat <<'JSON'
          {
            "embeds": [{
              "title": "ğŸšš Push to ${BRANCH}",
              "url": "${COMPARE}",
              "description": "**${PUSER}** pushed ${COUNT} commit(s).",
              "color": 5793266,
              "footer": { "text": "${REPO}" }
            }]
          }
          JSON
          )
          
          echo "$payload" | envsubst | curl -s -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK_URL"
